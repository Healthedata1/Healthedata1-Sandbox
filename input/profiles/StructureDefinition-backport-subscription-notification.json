{
  "resourceType": "StructureDefinition",
  "id": "backport-subscription-notification",
  "extension": [
    {
      "url": "http://hl7.org/fhir/StructureDefinition/structuredefinition-category",
      "valueString": "Foundation.Other"
    },
    {
      "url": "http://hl7.org/fhir/StructureDefinition/structuredefinition-security-category",
      "valueCode": "not-classified"
    }
  ],
  "url": "http://www.fhir.org/guides/healthedata1-sandbox/StructureDefinition/backport-subscription-notification",
  "version": "0.1.0",
  "name": "BackportSubscriptionNotification",
  "title": "Backported R5 Subscription Notification Bundle",
  "status": "active",
  "description": "Profile on the R4 Bundle resource to enable R5-style topic-based subscription notifications in FHIR R4.",
  "fhirVersion": "4.0.1",
  "mapping": [
    {
      "identity": "v2",
      "uri": "http://hl7.org/v2",
      "name": "HL7 v2 Mapping"
    },
    {
      "identity": "rim",
      "uri": "http://hl7.org/v3",
      "name": "RIM Mapping"
    },
    {
      "identity": "cda",
      "uri": "http://hl7.org/v3/cda",
      "name": "CDA (R2)"
    },
    {
      "identity": "w5",
      "uri": "http://hl7.org/fhir/fivews",
      "name": "FiveWs Pattern Mapping"
    }
  ],
  "kind": "resource",
  "abstract": false,
  "type": "Bundle",
  "baseDefinition": "http://hl7.org/fhir/StructureDefinition/Bundle",
  "derivation": "constraint",
  "differential": {
    "element": [
      {
        "id": "Bundle",
        "path": "Bundle",
        "constraint": [
          {
            "key": "bdl-1",
            "severity": "error",
            "human": "total only when a search or history",
            "expression": "total.empty() or (type = 'searchset') or (type = 'history')",
            "xpath": "not(f:total) or (f:type/@value = 'searchset') or (f:type/@value = 'history')"
          },
          {
            "key": "bdl-2",
            "severity": "error",
            "human": "entry.search only when a search",
            "expression": "entry.search.empty() or (type = 'searchset')",
            "xpath": "not(f:entry/f:search) or (f:type/@value = 'searchset')"
          },
          {
            "key": "bdl-3",
            "severity": "error",
            "human": "entry.request mandatory for batch/transaction/history, otherwise prohibited",
            "expression": "entry.all(request.exists() = (%resource.type = 'batch' or %resource.type = 'transaction' or %resource.type = 'history'))",
            "xpath": "not(f:entry/f:request) or (f:type/@value = 'batch') or (f:type/@value = 'transaction') or (f:type/@value = 'history')"
          },
          {
            "key": "bdl-4",
            "severity": "error",
            "human": "entry.response mandatory for batch-response/transaction-response/history, otherwise prohibited",
            "expression": "entry.all(response.exists() = (%resource.type = 'batch-response' or %resource.type = 'transaction-response' or %resource.type = 'history'))",
            "xpath": "not(f:entry/f:response) or (f:type/@value = 'batch-response') or (f:type/@value = 'transaction-response') or (f:type/@value = 'history')"
          },
          {
            "key": "bdl-7",
            "severity": "error",
            "human": "FullUrl must be unique in a bundle, or else entries with the same fullUrl must have different meta.versionId (except in history bundles)",
            "expression": "(type = 'history') or entry.where(fullUrl.exists()).select(fullUrl&resource.meta.versionId).isDistinct()",
            "xpath": "(f:type/@value = 'history') or (count(for $entry in f:entry[f:resource] return $entry[count(parent::f:Bundle/f:entry[f:fullUrl/@value=$entry/f:fullUrl/@value and ((not(f:resource/*/f:meta/f:versionId/@value) and not($entry/f:resource/*/f:meta/f:versionId/@value)) or f:resource/*/f:meta/f:versionId/@value=$entry/f:resource/*/f:meta/f:versionId/@value)])!=1])=0)"
          },
          {
            "key": "bdl-9",
            "severity": "error",
            "human": "A document must have an identifier with a system and a value",
            "expression": "type = 'document' implies (identifier.system.exists() and identifier.value.exists())",
            "xpath": "not(f:type/@value = 'document') or exists(f:identifier/f:system) or exists(f:identifier/f:value)"
          },
          {
            "key": "bdl-10",
            "severity": "error",
            "human": "A document must have a date",
            "expression": "type = 'document' implies (timestamp.hasValue())",
            "xpath": "not(f:type/@value = 'document') or exists(f:timestamp/@value)"
          },
          {
            "key": "bdl-11",
            "severity": "error",
            "human": "A document must have a Composition as the first resource",
            "expression": "type = 'document' implies entry.first().resource.is(Composition)",
            "xpath": "not(f:type/@value='document') or f:entry[1]/f:resource/f:Composition"
          },
          {
            "key": "bdl-12",
            "severity": "error",
            "human": "A message must have a MessageHeader as the first resource",
            "expression": "type = 'message' implies entry.first().resource.is(MessageHeader)",
            "xpath": "not(f:type/@value='message') or f:entry[1]/f:resource/f:MessageHeader"
          },
          {
            "key": "backport-notification-bundle-1",
            "severity": "error",
            "human": "A notification bundle MUST have the BackportSubscriptionStatus as the first entry",
            "expression": "entry.first().resource.is(SubscriptionStatus)",
            "xpath": "f:entry[1]/f:resource/f:SubscriptionStatus",
            "source": "http://www.fhir.org/guides/healthedata1-sandbox/StructureDefinition/backport-subscription-notification"
          }
        ]
      },
      {
        "id": "Bundle.type",
        "path": "Bundle.type",
        "patternCode": "history"
      },
      {
        "id": "Bundle.entry",
        "path": "Bundle.entry",
        "slicing": {
          "discriminator": [
            {
              "type": "type",
              "path": "resource"
            }
          ],
          "rules": "open",
          "ordered": false,
          "description": "Slice based on resource"
        },
        "min": 1
      },
      {
        "id": "Bundle.entry:subscriptionStatus",
        "path": "Bundle.entry",
        "sliceName": "subscriptionStatus",
        "min": 1,
        "max": "*",
        "mustSupport": true
      },
      {
        "id": "Bundle.entry:subscriptionStatus.resource",
        "path": "Bundle.entry.resource",
        "min": 1,
        "type": [
          {
            "code": "Parameters",
            "profile": [
              "http://www.fhir.org/guides/healthedata1-sandbox/StructureDefinition/backport-subscription-status"
            ]
          }
        ],
        "mustSupport": true
      }
    ]
  }
}
